(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{DkB1:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const a=t?"https":"http";return`${a}://${app.state.get(["community","network","schemaDomain"])}/e/${e}`},e.exports=t.default},FVbV:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BUILD_STATUS_MESSAGES=void 0,t.addPage=function(e){return r.resolveOnLocalUpdate(app.state.get(["doc","id"]),[{p:["draft","customstory_pages",e],li:{content_items:[],hed:i("Untitled"),dek:i(""),slug:i(""),seo_title:i(""),seo_description:i(""),social_title:i(""),social_description:i("")}}])},t.contentItemFallbackTitle=function(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};switch(t.content_type){case"image":e=t.image.caption||t.image.credit||"";break;case"video":e=t.video.title||"";break;case"oembed":e=t.oembed.title||"";break;case"text":e=s(t.body)||"",e=e.length>40?e.substring(0,40)+"...":e}return e||"Untitled"},t.createBuild=function(){return app.state.set("customstoryBuildSent",!0),g("/api/csk-service/graphql",{query:h.createBuild,variables:JSON.stringify({projectUuid:app.state.get(["doc","uuid"])})},{cache:!1,handleError:!1})},t.editContentItem=function(e,t){l.closeModal();const a=["draft","customstory_pages",e,"content_items",t],n=o(app.state.get(["doc","head","contents"]),a),s=app.state.get(["doc","id"]);switch(n.content_type){case"image":d.getAndEditImage(n.image,"image_customstory",{docId:s,path:a});break;case"video":c.getAndEditVideo(n.video,"Update",{docId:s,path:a});break;case"oembed":u.editOembed(n.oembed,"Update",{docId:s,path:a});break;case"text":p.openOverlay({editCustomstoryText:{docId:s,path:a}})}},t.editPage=function(e,t){l.pushModal({editCustomstoryPage:{path:e,imageType:t}})},t.getBuildStatusFromBuild=function(e){if(e.success)return f.ok;switch(e.status){case"failed":return f.err;case"queued":return f.queued;default:return f.building}},t.getCustomstoryStatus=async function(){return(await b()).customstoryStatus},t.getProject=b,t.getProjectSource=async function(){return(await b()).source},t.insertContentItem=function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=app.state.get(["doc","head","contents"]),s=o(n,e);s||(s={content_id:y(),content_type:t});switch(t){case"image":s.image=d.imageFromData(a);break;case"video":s.video=a;break;case"oembed":s.oembed=a;break;case"text":s.body=s.body||i(""),s.metadata={properties:[]}}r.localUpdate(app.state.get(["doc","id"]),[{p:e,ld:o(n,e),li:s}])},t.insertContentItemMetadata=async function(e,t,a){const s=app.state.get(["doc","id"]),i=o(app.state.get(["doc","head","contents"]),e)||{};let d=[];t!==i.title&&d.push({p:e.concat("title"),od:i.title,oi:t});a=function(e){e.properties&&(e.properties=e.properties.filter(e=>{let{key:t,value:a}=e;return t||a}));return e}(a),n(a,i.metadata)||d.push({p:e.concat("metadata"),od:i.metadata,oi:a});d.length>0&&(await r.resolveOnClean(s),r.localUpdate(s,d))},t.moveContentItem=function(e,t,a,o){if(e===t)r.localUpdate(app.state.get(["doc","id"]),[{p:["draft","customstory_pages",t,"content_items",a],lm:o}]);else{const n=app.state.get(["doc","head","contents","draft","customstory_pages",e,"content_items",a]);r.localUpdate(app.state.get(["doc","id"]),[{p:["draft","customstory_pages",e,"content_items",a],ld:n},{p:["draft","customstory_pages",t,"content_items",o],li:n}])}},t.removeContentItem=function(e,t){const a=app.state.get(["doc","head","contents","draft","customstory_pages",e,"content_items",t]);r.localUpdate(app.state.get(["doc","id"]),[{p:["draft","customstory_pages",e,"content_items",t],ld:a}])},t.removePage=function(e,t){r.localUpdate(app.state.get(["doc","id"]),[{p:["draft","customstory_pages",e],ld:t}])};const{get:o,isEqual:n}=a("LvDl"),s=a("K5N4").toPlaintext,r=a("dnr0"),i=a("oRrG"),d=a("mlrC"),c=a("mt4P"),u=a("L7l5"),l=a("tz4B"),p=a("Mw5B"),m=a("q1SX"),g=a("XhB+"),h=a("a/tZ"),f={none:"No build",rebuild:"Rebuild needed",err:"Build error",queued:"Build queued",building:"Building",ok:"Build OK"};function y(){return Math.random().toString(36).slice(2).replace(/^[0-9]*([a-z0-9]*)/,"$1").slice(0,8).toUpperCase()}async function b(){let e,t;try{app.state.set(["customstoryStatus","statusPending"],!0);const a=await g("/api/csk-service/graphql",{query:h.projectSource,variables:JSON.stringify({uuid:app.state.get(["doc","uuid"])})},{cache:!1,handleError:!1});app.state.set(["customstoryStatus","statusPending"],!1),e=a.projectSource,t=await async function(e){if(!e||0===e.builds.length)return{statusLabel:f.none};const t=e.builds[0];if(t.success){return t.lastModified<app.state.get(["doc","updated_at"])?{statusLabel:f.rebuild}:{statusLabel:f.ok}}switch(t.status){case"failed":return{statusLabel:f.err,statusMessage:t.statusMessage};case"queued":return{statusLabel:f.queued};default:return{statusLabel:f.building}}}(e)}catch(e){m.reportError(e,!1),t={statusLabel:"Unable to retrieve build status",statusMessage:"",statusPending:!1}}return app.state.set(["customstoryStatus"],t),e&&app.state.set(["customstoryBuilds"],e.builds),{source:e,customstoryStatus:t}}t.BUILD_STATUS_MESSAGES=f},J18f:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.editLeadArt=function(e,t,a,d,c,u){var l=app.state.get(["doc","id"]),p=app.state.get(["doc","head","contents"]),m=o(p,t)||o(p,u),g=o(p,a),h=o(p,d),f=o(p,c);g?n.getAndEditVideo(g,"Update",{docId:l,path:a}):h?i.editOembed(h,"Update",{docId:l,path:d}):f?r.editDoc(f.id,"Update",{docId:l,path:c}):m&&s.getAndEditImage(m,`image_${e}art`,{docId:l,path:t})},t.removeLeadArt=function(e,t,a,n){var s=app.state.get(["doc","id"]),r=app.state.get(["doc","head","contents"]),i=o(r,e),d=o(r,t),u=o(r,a),l=o(r,n);i&&c.localUpdate(s,[{p:e,od:i}]);d&&c.localUpdate(s,[{p:t,od:d}]);u&&c.localUpdate(s,[{p:a,od:u}]);l&&c.localUpdate(s,[{p:n,od:l}])},t.replaceAdditionalArtWithMain=function(){var e=app.state.get(["doc","id"]),t=app.state.get(["doc","head","contents"]),a=["draft","main_image"],n=o(t,a),r="page"!==app.state.get(["docLabel"]);if(!n)return Promise.resolve();return s.saveImage(n).then(t=>{r&&!u(n)&&(g(t,l),g(t,p)),g(t,m),c.localUpdate(e,[{p:a,od:n}])}).catch(e=>{d.reportError(e)})};var{get:o}=a("LvDl"),n=a("mt4P"),s=a("mlrC"),r=a("TmjU"),i=a("L7l5"),d=a("q1SX"),c=a("dnr0"),u=a("v2gr");const l=["draft","seo_image"],p=["draft","social_image"],m=["draft","internal_image"];function g(e,t){var a=app.state.get(["doc","id"]),n=app.state.get(["doc","head","contents"]);o(n,t)||s.insertImageAtPath({docId:a,path:t},e)}},L7l5:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.editOembed=h,t.getOembed=f,t.getOembedOrVideo=function(e,t,a){return i.getYoutubeVideoFromUrl(e,t,a).catch(()=>(/twitch\.tv/.test(e)&&(e+=e.includes("?")?"&parent=":"?parent=",e+=app.state.get(["community","schemaDomain"])),f({url:e}).then(e=>{h(e,t,a)})))},t.getOembedType=y,t.getOembedUrlFromHtml=async function(e){const t=document.createElement("div");t.innerHTML=e;const a=Array.from(t.getElementsByTagName("blockquote")),o=Array.from(t.getElementsByTagName("iframe"));let n;for(let e of a)if(m.includes(e.getAttribute("class"))){const t=Array.from(e.getElementsByTagName("a")),a=await Promise.all(t.map(async e=>({link:e,oembedType:await y({url:e.href})})));if(n=a.find(e=>g.includes(e.oembedType)),n)return n.link.getAttribute("href")}for(let e of o){const t=e.getAttribute("src");if(n=await y({url:t}),g.includes(n)){if("youtube_playlist"===n){return"https://www.youtube.com/playlist?list="+t.split("=")[1]}return"soundcloud"===n?t.split("url=")[1].replace(/%3A/g,":"):t}}},t.insertOembed=function(e,t){let{docId:a,lineId:o,path:n}=e;if(n){if(n.includes("customstory_pages"))c.insertContentItem(n,"oembed",t);else{var s=l.getDocCursor(a).get(["head","contents"].concat(n));"main_oembed"===n[1]?u.replaceAdditionalArtWithMain().then(()=>{l.localUpdate(a,[{p:n,od:s,oi:t}])}):l.localUpdate(a,[{p:n,od:s,oi:t}])}}else r.insertObject({docId:a,lineId:o},{oembed:t})},t.selectOembed=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};d.pushModal({selectOembed:{url:e,target:t}})};const{pick:o}=a("LvDl"),n=a("kh36"),s=a("6fkZ"),r=a("jdJs"),i=a("mt4P"),d=a("tz4B"),c=a("FVbV"),u=a("J18f"),l=a("dnr0"),p=["type","url","html","title","author_name","author_url","provider_name","provider_url","thumbnail_url","thumbnail_width","thumbnail_height"],m=["twitter-tweet","instagram-media"],g=["twitter_status","twitter_profile","youtube","youtube_playlist","instagram","soundcloud","twitch"];function h(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o={editObject:{data:e,label:t,type:"oembed",target:a}};d.getModal("selectOembed")?d.pushModal(o):d.pushModal(o,{selectOembed:{url:e.url,target:a},tail:app.state.get("modal")})}function f(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return n("/api/content/oembed",{query:e,opts:{handleError:!1}}).then(a=>{if(!a.html){let t=s.OEMBED_SUPPORT_ERROR;return"YouTube"===a.provider_name?t=s.OEMBED_YOUTUBE_SUPPORT_ERROR:".pdf"===e.url.split("?")[0].slice(-4).toLowerCase()&&(t=s.OEMBED_PDF_SUPPORT_ERROR),Promise.reject(new Error(t))}const n=o(a,p);return Object.keys(t).length>0?n.options=t:a.default_options&&(n.options=a.default_options),n}).catch(e=>(e.message!==s.OEMBED_SUPPORT_ERROR&&e.message!==s.OEMBED_YOUTUBE_SUPPORT_ERROR&&e.message!==s.OEMBED_PDF_SUPPORT_ERROR&&(e=new Error(s.OEMBED_GENERIC_ERROR)),Promise.reject(e.message)))}function y(e){const t=e.url,a=e.provider_name;return n("/api/content/oembed/type",{query:{url:t,provider_name:a},opts:{handleError:!1}}).then(e=>e.oembedType).catch(e=>(e=new Error(s.OEMBED_GENERIC_ERROR),Promise.reject(e)))}},Mw5B:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.closeOverlay=function(){var e=app.state.get("overlay");e&&e.tail?app.state.set("overlay",e.tail):app.state.set("overlay",null)},t.getOverlay=function(e){return app.state.get("overlay",e)},t.openOverlay=function(e){app.state.set("overlay",e),app.state.get("modal")||setTimeout(()=>{document.querySelector(".m-overlay").classList.add("is-full-screen")},0)},t.pushOverlay=function(e){var t=app.state.get("overlay");t&&Object.keys(e)[0]!==Object.keys(t)[0]&&(e.tail=t.tail||t);app.state.set("overlay",e)}},TmjU:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MAX_POLL_CHAR_COUNT=void 0,t.createDoc=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};r.createDoc(e,a).then(e=>{let{id:a}=e;return g(a,"Insert",t)})},t.editDoc=g,t.editMetadata=function(){var e=app.state.get(["subdoc","schema_name"]),t=`edit${o(e)}Data`,a={[t]:!0};d.getModal(t)||d.pushModal(a,{})},t.getDocHtml=async function(){var e=app.state.get(["subdoc"]),{data:t}=await r.getEntryParams(e.id),a="/api/chorus/cell/unison_anthem_component/"+e.schema_name;return n(a,{method:"POST",query:{community_id:app.state.get(["community","id"])},body:{data:t,layout:!0},opts:{handleError:!1}}).then(e=>{let{html:t}=e;return t})},t.initDoc=m,t.insertDoc=function(e,t,a){var o={type:a,id:t};if(e.path){var n=s.getDocCursor(e.docId).get(["head","contents"].concat(e.path));"main_gallery"===e.path[1]?l.replaceAdditionalArtWithMain().then(()=>{s.localUpdate(e.docId,[{p:e.path,od:n,oi:o}])}):s.localUpdate(e.docId,[{p:e.path,od:n,oi:o}])}else u.insertObject(app.state.get(["doc","id"]),e.lineId,{doc:o})},t.refreshDocIframes=h,t.selectDoc=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};d.pushModal({selectSubdoc:{schemaName:e,target:t}})},t.teardownDoc=async function(e){const t=app.state.get(["doc"]);await s.resolveOnClean(t.id),i(t.head.contents).includes(e)?await s.resolveOnClean(e):await s.teardownDoc(e);s.unsetDocAlias(["subdoc"]),h(e)};var{startCase:o}=a("LvDl"),n=a("kh36"),s=a("dnr0"),r=a("SiKE"),i=a("7a9H"),d=a("tz4B"),c=a("Mw5B"),u=a("e5Yr"),l=a("J18f");const p=["poll"];function m(e){var t=s.docInState(e);return t?s.setDoc(t,["subdoc"]):r.getDoc(e).then(e=>s.setAndInitDoc(e,!1,["subdoc"]))}function g(e,t,a){return m(e).then(()=>{var o=app.state.get(["subdoc","schema_name"]);return p.includes(o)?function(e,t,a){d.pushModal({editSubdoc:{docId:e,label:t,target:a}})}(e,t,a):function(e,t,a){d.closeModal(),c.openOverlay({editSubdoc:{docId:e,label:t,target:a}})}(e,t,a)})}function h(e){var t=Array.from(document.getElementsByTagName("iframe"));for(let o of t){var a=JSON.parse(o.getAttribute("data-object"));a&&a.doc&&a.doc.id===e&&(o.src=o.src)}}t.MAX_POLL_CHAR_COUNT=255},"a/tZ":function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.projectSource=t.createBuild=void 0;t.projectSource="\n  query projectSource($uuid: String!) {\n    projectSource(uuid: $uuid) {\n      uuid\n      type\n      lastModified\n      builds {\n        uuid\n        status\n        statusMessage\n        success\n        lastModified\n        log\n      }\n    }\n  }\n";t.createBuild="\n  mutation createBuild($projectUuid:String!) {\n    createBuild(input:{projectUuid: $projectUuid}){\n      uuid\n      status\n      success\n      lastModified\n    }\n  }\n"},jdJs:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.editObject=function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};var n=Object.keys(e)[0];o.pushModal({editObject:{data:e[n],label:t,type:n,target:a}})},t.insertObject=function(e,t){let{docId:a,lineId:s}=e;n.insertObject(a,s,t),o.closeModal()};var o=a("tz4B"),n=a("e5Yr")},mt4P:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.editVideo=g,t.getAndEditVideo=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Insert",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return o("/api/volume/videos/"+e.id).then(o=>{var n=h(o);return g(Object.assign({},n,e),t,a)})},t.getYoutubeVideoFromUrl=function(e,t,a){var n=function(e){if(e.match(/youtube/)&&!e.includes("playlist"))return e.match(/((\/embed\/)|([?&]v=))([^&?]+)/)[4];if(e.match(/youtu.be/))return e.match(/.be\/(\S+)/)[1];return null}(e);if(!n)return Promise.reject();return o("/api/volume/videos/from_youtube.json",{method:"POST",query:{youtube_id:n},opts:{handleError:!1}}).then(e=>{if(a.path){var o=a.path.findIndex(e=>"string"==typeof e&&e.includes("oembed"));o>-1&&(a.path[o]=a.path[o].replace("oembed","video"))}return g(h(e,"youtube"),t,a)})},t.insertVideo=function(e,t){let{docId:a,lineId:o,path:n}=e;t.caption=t.caption?s(t.caption):"";var r={id:t.id,uuid:t.uuid,title:t.title,playerType:t.playerType,autoplay:t.autoplay,caption:t.caption,mask_text:t.mask_text};if(n){var l=u.getDocCursor(a).get(["head","contents"].concat(n)),p=n[n.length-1];n.includes("customstory_pages")?d.insertContentItem(n,"video",r):"number"==typeof p?u.localUpdate(a,[{p:n,ld:l,li:{video:r}}]):"main_video"===n[1]?c.replaceAdditionalArtWithMain().then(()=>{u.localUpdate(a,[{p:n,od:l,oi:r}])}):u.localUpdate(a,[{p:n,od:l,oi:r}])}else i.insertObject(a,o,{video:r})},t.searchVideos=function(e){e.page||(e.page=1);return e.results_per_page=6,e.results_type="simple",e.has_assets=!0,o("/api/volume/videos/search.json",{query:e,opts:{withHeaders:!0}}).then(t=>{var a=t.data;return[a.results.map(e=>h(e)),n({page:e.page,perPage:e.results_per_page,total:parseInt(a.results_count)})]})},t.selectVideo=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r.pushModal({selectVideo:{target:e}})},t.storeSelectVideo=function(e){app.state.set(["modal","selectVideo","results"],e)};var o=a("kh36"),n=a("JOwg"),s=a("kabW"),r=a("tz4B"),i=a("e5Yr"),d=a("FVbV"),c=a("J18f"),u=a("dnr0"),{startCase:l,get:p}=a("LvDl");const m=["YouTube","Chorus"];function g(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};var o={editObject:{data:e,label:t,target:a,type:"video"}};r.getModal("selectVideo")?r.pushModal(o):r.pushModal(o,{selectVideo:{target:a},tail:app.state.get("modal")})}function h(e,t){var a=e.autoplay;return null==a&&(a=app.state.get(["community","network","autoplayDefault"])),{id:e.id,uuid:e.uuid,title:e.title_short,playerType:t||"",playerTypes:f(e.assets||e.video_assets,e.default_players),autoplay:a,mask_text:e.mask_text}}function f(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=y(p(t,["desktop","name"],"")),o=e.reduce((e,t)=>{let o=y(t.type.split("Asset")[0]);return o!==a&&m.includes(o)&&!e.includes(o)&&e.push(o),e},[]);return a&&o.unshift(`Default (${a})`),o}function y(e){return"youtube"===e.toLowerCase()?"YouTube":l(e)}}}]);
//# sourceMappingURL=0.e7c74798353553dd8b0c.0.js.map